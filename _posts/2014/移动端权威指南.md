# Angular 移动端权威指南

原文地址:<http://www.ng-newsletter.com/posts/angular-on-mobile.html>

ps:删除了 Cordova 安装 编译 等等部分

移动应用对开发人员来说不是一个未来科技.它们已经广泛存在了.现在有12亿web app 用户并且这个数字还在快速增长(原文2013年10月).不久这个数字一定会超过桌面端的用户数量.以这个速率估计,在2017年将有51亿的用户使用移动手机.

对我们这些app开发者来说,如果我们想保持竞争力就得磨练握们移动开发技能.

<!--more-->

>在AngularJS上,我们对移动应用有一些很棒的支持. ----Angular 团队及社区

在这篇文章中,我们通过两种不同的方式提供给用户一个移动应用的体验

* 响应式 web 应用
* 使用Cordova创建原生程序

## 响应式 Web 应用

最简单的方法支持移动应用是使用HTML 和 CSS,来创建基于移动的Angular app.因为Angular本身就基于HTML,我们设计和整合响应式设计就只需构建支持不同设备的结构.

### 交互

对应桌面,创建交互设计就是通过ng-click和直接量家族.

从Angular 1.2.0开始,我们开始有能力处理__touch__事件了,因为引入了`ngTouch`模块.
因为`ngTouch`不是包含在核心库中,我们需要安装这个库文件.

### 安装

安装`ngTouch`可以通过几种方法.最简单的方法就是直接在<http://angular.org>下载源码.

在下载页面找到`extras `条目,让后点击选择下载`ng-touch.js`到app可以访问的位置.

或者我们可以使用__Bower__来安装`angular-touch`:
```
$ bower install angular-touch --save```

并且我们需要在index.html中引用库文件

```
<script src="/bower_components/angular-touch/angular-touch.js"></script>```

最后,把`ngTouch`包含到我们的app中:

```
angular.module('myApp', ['ngTouch']);```

现在我们可以使用ngTouch库了.

### ngTouch

移动浏览器和桌面浏览器的工作方式有些不同.在处理 __click__ 事件上.
移动浏览器监听到一个_tap_事件后等待300ms才去监听其他的_tap_事件.比如如何我们tap两下移动设备,因为有这个延迟,
浏览器只会触发一个click 事件.

这个延迟让我们的app感觉上难以响应.但我们可以不处理`click`事件,而处理 `touch` 事件.

`ngTouch`库无缝地通过`ng-click`直接量处理这些监听.而且会为我们处理好正确`click`事件.就是说快速的多个`click`事件也可以被触发.

>在double-click的中,第一个触发后,浏览器的click延时操作被调用.`ng-Touch`会帮我们处理这个动作,引发一个`双击`操作.

使用`ngClick`直接量在移动设备上就像在桌面浏览器上一样.

```
<button ng-click="save()">Save</button>```

`ngTouch`也引入了两个新的直接量:_swipe_直接量,这些swipe直接两允许用户滑动,向左或者向右滑动.比如幻灯片滑动到
下一个照片之类的情形.

`ngSwipeLeft`直接量监听当一个元素有从右滑到左边,反过来,`ngSwipeRight`监听一个元素从左滑到右边.

> `ngSwipe*`的一个有意思的特性是它可以在触摸屏上工作的像鼠标点击和拖拽效果.

使用`ngSwipeLeft`和`ngSwipeRight`直接量很容易.比如我们有一组email,我们想为每个email安放滑到操作,就像流行的移动
应用Mailbox

我们可以简单的使用swipe直接量实现这个功能.当我们显示我们的email列表时,我们在一个方向监听swipe,是我们可以在特定的mail条目上
展示这个效果.

当我们显示这个动作效果时,我们使用swiping在另一个方向,隐藏我们想处理的动作.

```
    <ul>
      <li ng-repeat="mail in emails">
        <div
          ng-show="!mail.showActions"
          ng-swipe-left="mail.showActions=true">
          <div class="from">
            From: <span>{{ mail.from }}</span>
          </div>
          <div class="body">
            {{ mail.body }}
          </div>
        </div>
        <div
          ng-show="mail.showActions"
          ng-swipe-right="mail.showActions=false">
          <ul class="actions">
            <li><button>Archive</button></li>
            <li><button>Trash</button></li>
          </ul>
        </div>
      </li>
    </ul>
```

### swipe service

对应更多基于触屏定制的动画,我们可以使用 `$swpie` 服务来直接实现. `$swipe` 服务是一个按住拖拽动作的抽象.

`$swipe` 服务有一个方法叫`bind()`, 这个`bind()`方法需要一个元素作为参数,它会绑定四个事件处理器和swipe动作到这个元素上.

这些事件处理器被调用时会包含一个坐标对象,就像:{x:200,y:200}

四个事件处理器分别处理下列事件:

#### start

`start`事件被`mousedown`或者`touchstart`事件触发.这个事件后,`$swipe`服务会监听`touchmove`和`mousemove`事件,为了防止意外滑动,这些事件只会在很小的距离上被触发.

一旦移动距离超过这个上限,紧接着一个或者两个事件会被触发.

* 如果竖直距离大于水平距离,浏览器会作为scroll事件接受
* 如果水平大于竖直,浏览器会视为一个swipe事件,然后我们的`move`和`end`事件会被紧接着触发.

#### move

`move`事件只在`$swipe`判断这是一个swipe事件后被`mousemove`和`touchmove`触发

#### end

`end` 事件只在`move`事件被触发后被`touchend`和`mousup`事件触发.

#### cancel

`cancel`事件是被`touchcancel`或者在`start`被判断为scroll事件后触发

比如,我们可以创建一个直接量,使滑动条可以控制幻灯片.为了在移动设备上控制,我们使用`$swipe`服务来处理我们
定制的逻辑(如何展示UI):

```
    angular.module('myApp')
    .directive('mySlideController', ['$swipe',
      function($swipe) {

        return {
          restrict: 'EA',
          link: function(scope, ele, attrs, ctrl) {
            var startX, pointX;

            $swipe.bind(ele, {
              'start': function(coords) {
                startX = coords.x;
                pointX = coords.y;
              },
              'move': function(coords) {
                var delta = coords.x - pointX;
                // ...
              },
              'end': function(coords) {
                // ...
              },
              'cancel': function(coords) {
                // ...
              }
            });
          }
        }
    }]);
```

### angular-gestures 和 multi-touch 手势

Angular-gestures 是一个Angular 模块,使我们可以处理Angular应用上的多点触控.基于流行的`Hammer.js`库.

Hammer.js 库提供了一组触摸屏共同的直接

* Tap
* DoubleTap
* Swipe
* Drag
* Pinch
* Rotate

`angular-gestures` 库文件使我们可以在 Angular 直接量中使用这些事件.例如,下面的是可用的直接量.

* hmDoubleTap
* hmDragStart
* hmDrag
* hmDragUp
* hmDragDown
* hmDragLeft
* hmDragRight
* hmDragEnd
* hmHold
* hmPinch
* hmPinchIn
* hmPinchOut
* hmRelease
* hmRotate
* hmSwipe
* hmSwipeUp
* hmSwipeDown
* hmSwipeLeft
* hmSwipeRight
* hmTap
* hmTouch
* hmTransformStart
* hmTransform
* hmTransformEnd

### 安装 angular-gestures

为了安装`angular-gestures`库到我们的app中.我们需要包含gestures.js(或者gestures.min.js)到页面文件中.

我们可以在<https://github.com/wzr1337/angular-gestures>下载或者使用bower安装.

为了用Bower安装 angular-gestures,使用下面的命令.

```
    $ bower install --save angular-gestures```

最后,我们需要包含依赖到我们的app中

```
    angular.module('myApp', ['angular-gestures']);```

### 使用angular-gestures

Gestures 是 Angular的直接量.所以和其他直接量的使用方法一样.

打个比方,我想允许用户能在照片库中旋转,裁剪,缩放图片.我们可以使用 Hammer.js 库处理这些.

这个例子中,我们在元素上对`double tap`设置了一随机变化,我们使用了`hm-tap`直接量
```
    <div id="photowrapper">
      <div class="cardProps"
            hm-tap="tapped($event)">
        <div class="tradingcard">
          <img src="/img/ari.jpeg" alt="" />
          <span>Ari</span>
        </div>
        <div class="tradingcard">
          <img src="/img/nate.jpeg" alt="" />
          <span>Nate</span>
        </div>
      </div>
    </div>
```
这里没有什么特别之处.除了我们调用了一下直接量. `angular-gestures`直接量会处理图片的双tap事件.

>Hammer.js 直接量可以接收angular表达式.就是说我们可以像`ng-click`一样调用函数.

上面的例子,我们调用一个在`$scope`的函数`tapped()`,这个函数大概看起来想下面那样:
```
    $scope.tapped = function($event) {
      var ele = $event.target;
      var x = Math.floor(Math.random() * 200) + 1,
          y = Math.floor(Math.random() * 100) + 1,
          z = Math.floor(Math.random() * 6) + 1,
          rot = Math.floor(Math.random()*360)+1;
      $(ele).css({
        'transform':
          "translate3d("+x+"px,"+y+"px,"+z+"px)" +
          "rotate("+rot+"deg)"
      });
    }
```
`angular-gestures`库使我们可以通过`$event`访问事件.我们可以用这个事件的目标(`$event.target`)来知道哪个元素被点击了.
然后我们可以对这个元素做些酷炫的动作.

## 和Cordova一起创建原生应用

Cordova 是个免费的,开源框架,它允许我们使用标准Web APIS来创建移动应用,而不是使用原生代码. 它允许我们使用HTML,JavaScript,
CSS 和 AngularJS 来写移动应用,而不是使用 Objective-C 或者 Java.

Cordova 通过JavaScript APIs暴露了原生设备的权限,允许我们访问施行一些特定操作,比如获取地理位置和使用摄像头.这些是通过
插件架构支持的,我们可以利用Cordova内置的插件,比如访问扬声器.扫描条形码.

使用Cordova的好书是我们可以复用 Angular app的代码来支持移动环境.当然我们有一些问题要解决,比如性能和原生组建访问.

### Angular Cordova Servie

当Cordova app准备好了,设备连接好了,所有都准备好可以正常运行,Cordova 会触发一个浏览器事件`deviceready`.

在Angular 中,我们可以在这个事件完成后初始化我们的app.

为了初始化我们app,我们需要接受`deviceready`事件,我们需要设置一个事件监听器,然后我们可以手动初始化我们的应用:
```
    angular.module('myApp', []);

    var onDeviceReady = function() {
        angular.bootstrap( document, ['myApp']);
    }
    document.addEventListener('deviceready',
    onDeviceReady);
```
我们更喜欢使用一个可选的方法来监听`deviceready`事件,在`deviceready`触发后,建立一个绑定.

我们建立Angular 模块会监听`deviceready`事件,我们使用Service来监听`deviceready`事件,然后检索我们的
我们的Promises取决于是否事件被触发.

```
    angular.module('fsCordova', [])
    .service('CordovaService', ['$document', '$q',
      function($document, $q) {

        var d = $q.defer(),
            resolved = false;

        var self = this;
        this.ready = d.promise;

        document.addEventListener('deviceready', function() {
          resolved = true;
          d.resolve(window.cordova);
        });

        // Check to make sure we didn't miss the
        // event (just in case)
        setTimeout(function() {
          if (!resolved) {
            if (window.cordova) d.resolve(window.cordova);
          }
        }, 3000);
    }]);
```
然后我们把`fsCordova`作为一个依赖注入模块.
```
    angular.module('myApp', ['fsCordova'])
    // ...
```
我们可以使用`CordovaService`来检查Cordova是否ready了,我们可以在service ready后写一些逻辑.
```
    angular.module('myApp', ['fsCordova'])
    .controller('MyController',
      function($scope, CordovaService) {
        CordovaService.ready.then(function() {
          // Cordova is ready
        });
    });
```
### 包含 Angular

为了使我们的Angular app能够编译,我们需要下载angular文件,使其可以被index.html访问,我们推荐 `www/js/vendor/angular.js`

一旦设置好了,我们就可以编译我们的Angular app,我们需要把js文件包含在`www/index.html`中.

```
    <script type="text/javascript" src="js/vendor/angular.js"></script>
```

现在我们可以替换掉js/index.js成我们的angluar app,就行在桌面一样.

### 开发工作流

当开发app时,我们使用下面的工作流:

* 开启本地服务器(Cordova serve [platform])
* 编辑app
* 重新编译app(Cordova build [platform])

如果app不依赖于平台的话,我们可以直接在浏览器中编辑,这种情况下,我们只需要编译一遍我们的app就可以了
